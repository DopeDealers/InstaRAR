name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # Allow manual triggering

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up release environment
      run: |
        # Install required tools
        sudo apt-get update
        sudo apt-get install -y zip
        
    - name: Get version from VERSION file
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '\r\n')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Make release.sh executable
      run: chmod +x release.sh
      
    - name: Run release script
      run: ./release.sh
      
    - name: List release contents
      run: |
        echo "Release files created:"
        ls -la release/
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: InstaRAR v${{ steps.version.outputs.version }}
        body: |
          ## InstaRAR v${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ Complete InstaRAR Toolkit
          
          **What's Included:**
          - ğŸ¨ **instarar.ps1** - Interactive launcher with beautiful menu
          - ğŸ› ï¸ **ir_hardened.ps1** - Enhanced hardened WinRAR installer
          - ğŸ”‘ **ir_license.ps1** - WinRAR license manager
          - ğŸ—‘ï¸ **ir_unlicense.ps1** - License removal tool
          - ğŸ’» **CMD wrappers** - Double-click files for easy local use
          - ğŸ“– **Documentation** - Complete README and LICENSE
          
          ### ğŸš€ Quick Start
          **Interactive Menu (Recommended):**
          ```powershell
          irm "https://cdn.cyci.org/instarar.ps1" | iex
          ```
          
          **Individual Scripts:**
          ```powershell
          # Install WinRAR
          irm "https://cdn.cyci.org/ir_hardened.ps1" | iex
          
          # License WinRAR  
          irm "https://cdn.cyci.org/ir_license.ps1" | iex
          
          # Remove License
          irm "https://cdn.cyci.org/ir_unlicense.ps1" | iex
          ```
          
          **Local Use:**
          Download the ZIP, extract, and double-click any `.cmd` file
          
          ### âœ¨ Features
          - Enterprise-grade security with certificate pinning
          - Smart hash verification across multiple official sources
          - Comprehensive audit logging to Windows Event Log
          - True silent installation with proper UAC handling
          - Beautiful interactive menu interface
          - Always up-to-date via CDN distribution
          
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/instarar-${{ steps.version.outputs.version }}.zip
        asset_name: instarar-${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip
        
    - name: Summary
      run: |
        echo "ğŸ‰ Release created successfully!"
        echo "ğŸ“¦ Version: v${{ steps.version.outputs.version }}"
        echo "ğŸ“ Archive: instarar-${{ steps.version.outputs.version }}.zip"
        echo "ğŸ”— Check the Releases page for download link"
